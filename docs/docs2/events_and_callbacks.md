# Робота з подіями та колбеками в AML

Цей розділ описує механізм взаємодії між асинхронними подіями (наприклад, натискання гарячих клавіш або системні тригери) та скриптовими функціями AML.

## 1. Концепція колбеків (Callbacks)

Колбек — це функція AML, яка передається як аргумент до іншої функції (зазвичай системної або з Python-плагіна) для її подальшого виклику при настанні певної події.

### Приклад передачі функції як колбека:

```aml
func my_handler() {
    print("Гаряча клавіша спрацювала!")
}

// Передаємо назву функції або саму функцію
hk.register("ctrl+alt+t", my_handler)
```

## 2. Система подій (Event System)

Система подій дозволяє реалізувати архітектуру "видавець-підписник" (Pub/Sub) всередині ваших скриптів або між AML та Python.

### Модуль `temaune/sys/event`

- **`event.on(name, callback)`**: Підписує функцію на подію з вказаним іменем. Повертає унікальний ID підписки.
- **`event.off(name, id)`**: Скасовує підписку за її ID.
- **`event.emit(name, data)`**: Активує подію, викликаючи всі підписані функції та передаючи їм `data`.

### Приклад використання подій:

```aml
var event = import("temaune/sys/event")

// Створюємо обробник
func on_data_received(payload) {
    print("Отримано дані: " + payload.message)
}

// Підписуємося на подію
var sub_id = event.on("network_data", on_data_received)

// Викликаємо подію (наприклад, з іншого модуля або після завершення запиту)
event.emit("network_data", {"message": "Успішне підключення"})

// Відписка, якщо обробник більше не потрібен
event.off("network_data", sub_id)
```

## 3. Взаємодія з Python через `CallbackManager`

Якщо ви розробляєте власний Python-плагін і хочете викликати AML-функції, використовуйте `plugins/callback_manager.py`.

### В Python (плагін):
```python
from plugins import callback_manager

def do_something_async(aml_callback):
    # Реєструємо AML функцію
    cb_id = callback_manager.register(aml_callback)
    
    # Викликаємо її пізніше (можна з іншого потоку)
    callback_manager.execute(cb_id, ["Аргумент 1", 123])
```

## 4. Глобальні гарячі клавіші

Гарячі клавіші є окремим випадком системних подій, які працюють на рівні операційної системи (Windows).

```aml
var hk = import("temaune/ui/hotkey")

// Реєстрація
var hk_id = hk.register("ctrl+shift+x", func() {
    print("Виконано екстрене завершення")
    exit()
})
```

## Поради щодо використання

1. **Асинхронність**: Колбеки часто викликаються з інших потоків (особливо в системі подій або гарячих клавішах). Уникайте тривалих обчислень всередині колбеків, щоб не блокувати систему обробки повідомлень.
2. **Аргументи**: Система подій в AML зазвичай передає дані як один аргумент (об'єкт або список). Завжди перевіряйте структуру `data`, яку ви отримуєте в обробнику.
3. **Область видимості**: Колбеки зберігають доступ до глобальних змінних модуля, в якому вони були оголошені.
